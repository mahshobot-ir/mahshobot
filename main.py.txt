import os
import feedparser  # Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† RSS
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters
import google.generativeai as genai

# Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ
genai.configure(api_key=os.getenv("GEMINI_KEY_HERE"))  # Ø§Ø² Environment Variable
model = genai.GenerativeModel('gemini-1.5-flash')

# ÙØ§Ù†Ú©Ø´Ù† Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ (Ø§Ø² RSS Ø³Ø§ÛŒØª)
def get_latest_products():
    try:
        # RSS Ù…Ø­ØµÙˆÙ„Ø§Øª WooCommerce â€“ Ø§Ú¯Ø± Ù¾Ù„Ø§Ú¯ÛŒÙ† Ù†ØµØ¨ Ú©Ù†ÛŒØŒ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ù‡
        feed_url = "https://mahshobio.ir/feed/?post_type=product"  # ÛŒØ§ /?feed=products
        feed = feedparser.parse(feed_url)
        products = []
        for entry in feed.entries[:5]:  # Ûµ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¹Ù†ÙˆØ§Ù†ØŒ Ù„ÛŒÙ†Ú©ØŒ Ùˆ Ø¯Ø³ØªÙ‡ (Ø³Ø§Ø¯Ù‡)
            title = entry.title
            link = entry.link
            # Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø³Ø§Ø¯Ù‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ (Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ú¯Ø³ØªØ±Ø´ Ø¨Ø¯ÛŒ)
            category = "Ø¹Ù…ÙˆÙ…ÛŒ"
            if "Ø¬ÙˆØ´" in title.lower() or "acne" in title.lower():
                category = "Ø¬ÙˆØ´"
            elif "Ø®Ø´Ú©ÛŒ" in title.lower() or "dry" in title.lower():
                category = "Ø®Ø´Ú©ÛŒ"
            elif "Ù„Ú©" in title.lower() or "spot" in title.lower():
                category = "Ù„Ú©"
            elif "Ø­Ø³Ø§Ø³" in title.lower() or "sensitive" in title.lower():
                category = "Ø­Ø³Ø§Ø³ÛŒØª"
            products.append({"title": title, "link": link, "category": category})
        return products
    except:
        # Ø§Ú¯Ø± RSS Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ù…Ø­ØµÙˆÙ„Ø§Øª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ (Ø¯Ø³ØªÛŒ Ø¢Ù¾Ø¯ÛŒØª Ú©Ù†)
        return [
            {"title": "Ø³Ø±Ù… Ø¶Ø¯Ø¬ÙˆØ´ COSRX", "link": "https://mahshobio.ir/cosrx-acne", "category": "Ø¬ÙˆØ´"},
            {"title": "Ù‡ÛŒØ§Ù„ÙˆØ±ÙˆÙ†ÛŒÚ© Ordinary", "link": "https://mahshobio.ir/ordinary-hyaluronic", "category": "Ø®Ø´Ú©ÛŒ"},
            {"title": "Ø³Ø±Ù… Ù„Ú© Axis-Y", "link": "https://mahshobio.ir/axis-y-spot", "category": "Ù„Ú©"},
            {"title": "Ú©Ø±Ù… Ø­Ø³Ø§Ø³ Clinique", "link": "https://mahshobio.ir/clinique-calming", "category": "Ø­Ø³Ø§Ø³ÛŒØª"},
            {"title": "Ú©ÛŒØª Ø¹Ù…ÙˆÙ…ÛŒ", "link": "https://mahshobio.ir/skincare-kit", "category": "Ø¹Ù…ÙˆÙ…ÛŒ"}
        ]

async def start(update: Update, context):
    await update.message.reply_text(
        "Ø³Ù„Ø§Ù…! ğŸ‘‹\n"
        "Ø¹Ú©Ø³ Ù¾ÙˆØ³ØªØª Ø±Ùˆ Ø¨ÙØ±Ø³Øª + Ù…Ø´Ú©Ù„Øª Ø±Ùˆ Ø¨Ù†ÙˆÛŒØ³ (Ù…Ø«Ù„: Ø¬ÙˆØ´ Ø¯Ø§Ø±Ù…)\n"
        "Ù…Ù† Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ Ù…Ø§Ù‡â€ŒØ´Ùˆ Ø±Ùˆ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù…ÛŒâ€ŒØ¯Ù…!"
    )

async def handle_photo(update: Update, context):
    await update.message.reply_text("Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„ + Ú†Ú© Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯... â³")
    
    photo_file = await update.message.photo[-1].get_file()
    photo_bytes = await photo_file.download_as_bytearray()
    
    # Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø±Ùˆ Ø¨Ú¯ÛŒØ±
    latest_products = get_latest_products()
    products_text = "\n".join([f"- {p['title']}: {p['category']} ({p['link']})" for p in latest_products])

    try:
        response = model.generate_content([
            f"Ø¹Ú©Ø³ Ù¾ÙˆØ³Øª Ø±Ùˆ Ø¨Ø¨ÛŒÙ† Ùˆ Ù…Ø´Ú©Ù„ Ø±Ùˆ ØªØ´Ø®ÛŒØµ Ø¨Ø¯Ù‡.\n"
            "Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø³Ø§ÛŒØª: {products_text}\n"
            "Ù¾Ø§Ø³Ø® Ú©ÙˆØªØ§Ù‡ Ùˆ ÙØ§Ø±Ø³ÛŒ:\n"
            "1. Ù…Ø´Ú©Ù„ Ú†ÛŒÙ‡ØŸ\n"
            "2. Ø±ÙˆØªÛŒÙ† Û³ Ù…Ø±Ø­Ù„Ù‡ (ØµØ¨Ø­ØŒ Ø´Ø¨)\n"
            "3. Ù‡Ø´Ø¯Ø§Ø±: Ù…Ø´Ø§ÙˆØ±Ù‡ Ù¾Ø²Ø´Ú©ÛŒ Ù†ÛŒØ³Øª\n"
            "4. ÛŒÚ©ÛŒ Ø§Ø² Ù…Ø­ØµÙˆÙ„Ø§Øª Ø¬Ø¯ÛŒØ¯/Ù…Ø±ØªØ¨Ø· Ø±Ùˆ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ + Ù„ÛŒÙ†Ú© Ú©Ø§Ù…Ù„:\n"
            "   - Ø¬ÙˆØ´: Ù„ÛŒÙ†Ú© Ø§Ø² Ù„ÛŒØ³Øª\n"
            "   - Ø®Ø´Ú©ÛŒ: Ù„ÛŒÙ†Ú© Ø§Ø² Ù„ÛŒØ³Øª\n"
            "   - Ù„Ú©: Ù„ÛŒÙ†Ú© Ø§Ø² Ù„ÛŒØ³Øª\n"
            "   - Ø¹Ù…ÙˆÙ…ÛŒ: Ù„ÛŒÙ†Ú© Ø§Ø² Ù„ÛŒØ³Øª\n"
            "Ù„ÛŒÙ†Ú© Ø±Ùˆ Ø§ÛŒÙ†Ø¬ÙˆØ±ÛŒ Ø¨Ù†ÙˆÛŒØ³: [Ø®Ø±ÛŒØ¯ Ø¨Ø§ Û±Ûµ% ØªØ®ÙÛŒÙ](Ù„ÛŒÙ†Ú© Ú©Ø§Ù…Ù„)",
            {"inline_data": {"mime_type": "image/jpeg", "data": photo_bytes}}
        ])
        await update.message.reply_text(response.text)
    except:
        await update.message.reply_text("Ø¹Ú©Ø³ ÙˆØ§Ø¶Ø­ Ù†ÛŒØ³Øª! Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨ÙØ±Ø³Øª.")

# Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
app = Application.builder().token(os.getenv("BOT_TOKEN_HERE")).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
app.run_polling()