import os
import feedparser  # برای خواندن RSS
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters
import google.generativeai as genai

# هوش مصنوعی
genai.configure(api_key=os.getenv("GEMINI_KEY_HERE"))  # از Environment Variable
model = genai.GenerativeModel('gemini-1.5-flash')

# فانکشن اتوماتیک محصولات جدید (از RSS سایت)
def get_latest_products():
    try:
        # RSS محصولات WooCommerce – اگر پلاگین نصب کنی، کار می‌کنه
        feed_url = "https://mahshobio.ir/feed/?post_type=product"  # یا /?feed=products
        feed = feedparser.parse(feed_url)
        products = []
        for entry in feed.entries[:5]:  # ۵ محصول جدید
            # استخراج عنوان، لینک، و دسته (ساده)
            title = entry.title
            link = entry.link
            # دسته‌بندی ساده بر اساس کلمات کلیدی (می‌تونی گسترش بدی)
            category = "عمومی"
            if "جوش" in title.lower() or "acne" in title.lower():
                category = "جوش"
            elif "خشکی" in title.lower() or "dry" in title.lower():
                category = "خشکی"
            elif "لک" in title.lower() or "spot" in title.lower():
                category = "لک"
            elif "حساس" in title.lower() or "sensitive" in title.lower():
                category = "حساسیت"
            products.append({"title": title, "link": link, "category": category})
        return products
    except:
        # اگر RSS کار نکرد، محصولات پیش‌فرض (دستی آپدیت کن)
        return [
            {"title": "سرم ضدجوش COSRX", "link": "https://mahshobio.ir/cosrx-acne", "category": "جوش"},
            {"title": "هیالورونیک Ordinary", "link": "https://mahshobio.ir/ordinary-hyaluronic", "category": "خشکی"},
            {"title": "سرم لک Axis-Y", "link": "https://mahshobio.ir/axis-y-spot", "category": "لک"},
            {"title": "کرم حساس Clinique", "link": "https://mahshobio.ir/clinique-calming", "category": "حساسیت"},
            {"title": "کیت عمومی", "link": "https://mahshobio.ir/skincare-kit", "category": "عمومی"}
        ]

async def start(update: Update, context):
    await update.message.reply_text(
        "سلام! 👋\n"
        "عکس پوستت رو بفرست + مشکلت رو بنویس (مثل: جوش دارم)\n"
        "من محصولات جدید ماه‌شو رو اتوماتیک پیشنهاد می‌دم!"
    )

async def handle_photo(update: Update, context):
    await update.message.reply_text("در حال تحلیل + چک محصولات جدید... ⏳")
    
    photo_file = await update.message.photo[-1].get_file()
    photo_bytes = await photo_file.download_as_bytearray()
    
    # محصولات جدید رو بگیر
    latest_products = get_latest_products()
    products_text = "\n".join([f"- {p['title']}: {p['category']} ({p['link']})" for p in latest_products])

    try:
        response = model.generate_content([
            f"عکس پوست رو ببین و مشکل رو تشخیص بده.\n"
            "محصولات جدید سایت: {products_text}\n"
            "پاسخ کوتاه و فارسی:\n"
            "1. مشکل چیه؟\n"
            "2. روتین ۳ مرحله (صبح، شب)\n"
            "3. هشدار: مشاوره پزشکی نیست\n"
            "4. یکی از محصولات جدید/مرتبط رو پیشنهاد بده + لینک کامل:\n"
            "   - جوش: لینک از لیست\n"
            "   - خشکی: لینک از لیست\n"
            "   - لک: لینک از لیست\n"
            "   - عمومی: لینک از لیست\n"
            "لینک رو اینجوری بنویس: [خرید با ۱۵% تخفیف](لینک کامل)",
            {"inline_data": {"mime_type": "image/jpeg", "data": photo_bytes}}
        ])
        await update.message.reply_text(response.text)
    except:
        await update.message.reply_text("عکس واضح نیست! دوباره بفرست.")

# راه‌اندازی
app = Application.builder().token(os.getenv("BOT_TOKEN_HERE")).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
app.run_polling()